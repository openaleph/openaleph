# =============================================================================
# Development Services
# =============================================================================
# Minimal services for local development.
# Run backend and UI locally, not in containers.
#
# Usage:
#   make services    # Start all services
#   make api         # Run API locally
#   make worker      # Run worker locally
#   make ui          # Run UI locally (cd ui && npm start)

services:
  postgres:
    image: postgres:17
    ports:
      - "127.0.0.1:5432:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
    environment:
      POSTGRES_USER: aleph
      POSTGRES_PASSWORD: aleph
      POSTGRES_DATABASE: aleph

  elasticsearch:
    image: ghcr.io/openaleph/elasticsearch:9
    restart: on-failure
    ports:
      - "127.0.0.1:9200:9200"
    volumes:
      - elasticsearch-data:/usr/share/elasticsearch/data
    environment:
      - "ES_JAVA_OPTS=-Xms1g -Xmx1g"
      - "discovery.type=single-node"
      - "xpack.security.enabled=false"
      - "xpack.security.transport.ssl.enabled=false"
      - "xpack.security.http.ssl.enabled=false"
      - "http.cors.enabled=true"
      - "http.cors.allow-origin=/.*/"
      - "http.cors.allow-headers=/.*/"
      - "http.cors.allow-credentials=true"
      - "network.host=0.0.0.0"

  redis:
    image: redis:alpine
    command: ["redis-server", "--save", "3600", "10"]
    ports:
      - "127.0.0.1:6379:6379"
    volumes:
      - redis-data:/data

  ingest-file:
    image: ghcr.io/openaleph/ingest-file:latest
    command: procrastinate worker -q ingest --concurrency 2
    hostname: ingest
    tmpfs: /tmp
    volumes:
      - archive-data:/data
    depends_on:
      - postgres
      - redis
    restart: on-failure
    env_file:
      - aleph.env

  ftm-analyze:
    image: ghcr.io/dataresearchcenter/ftm-analyze:latest
    entrypoint: procrastinate worker -q analyze --concurrency 2
    restart: on-failure
    depends_on:
      - postgres
    tmpfs:
      - /tmp
    env_file:
      - aleph.env

volumes:
  archive-data:
  elasticsearch-data:
  postgres-data:
  redis-data:
